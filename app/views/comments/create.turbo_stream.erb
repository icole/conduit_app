<% if @post %>
  <% if @comment.reply? %>
    <!-- For replies, we need to reload the root comment to show the new nested reply -->
    <% root_comment = @comment.root_comment %>
    <%= turbo_stream.replace dom_id(root_comment) do %>
      <%= render "shared/comment", comment: root_comment %>
    <% end %>
    
    <!-- Hide the reply form after successful submission -->
    <%= turbo_stream.update "reply-form-#{@comment.parent.id}", "" %>
  <% else %>
    <!-- For top-level comments, append to the list -->
    <%= turbo_stream.append "post-#{@post.id}-comments-list" do %>
      <%= render "shared/comment", comment: @comment %>
    <% end %>
    
    <!-- Remove "no comments" message if this is the first comment -->
    <%= turbo_stream.remove "post-#{@post.id}-no-comments" %>
    
    <!-- Always reset the main comment form -->
    <%= turbo_stream.replace "new_comment_#{@post.id}" do %>
      <%= render "shared/comment_form", commentable: @post, comment: Comment.new %>
    <% end %>
  <% end %>
<% elsif @discussion_topic %>
  <% if @comment.reply? %>
    <!-- For replies, we need to reload the root comment to show the new nested reply -->
    <% root_comment = @comment.root_comment %>
    <%= turbo_stream.replace dom_id(root_comment) do %>
      <%= render "shared/comment", comment: root_comment %>
    <% end %>
    
    <!-- Hide the reply form after successful submission -->
    <%= turbo_stream.update "reply-form-#{@comment.parent.id}", "" %>
  <% else %>
    <!-- For top-level comments, append to the list -->
    <%= turbo_stream.append "discussiontopic-#{@discussion_topic.id}-comments-list" do %>
      <%= render "shared/comment", comment: @comment %>
    <% end %>
    
    <!-- Remove "no comments" message if this is the first comment -->
    <%= turbo_stream.remove "discussiontopic-#{@discussion_topic.id}-no-comments" %>
    
    <!-- Always reset the main comment form -->
    <%= turbo_stream.replace "new_comment_discussiontopic_#{@discussion_topic.id}" do %>
      <%= render "shared/comment_form", commentable: @discussion_topic, comment: Comment.new %>
    <% end %>
  <% end %>
<% elsif @chore %>
  <% if @comment.reply? %>
    <!-- For replies, we need to reload the root comment to show the new nested reply -->
    <% root_comment = @comment.root_comment %>
    <%= turbo_stream.replace dom_id(root_comment) do %>
      <%= render "shared/comment", comment: root_comment %>
    <% end %>

    <!-- Hide the reply form after successful submission -->
    <%= turbo_stream.update "reply-form-#{@comment.parent.id}", "" %>
  <% else %>
    <!-- For top-level comments, append to the list -->
    <%= turbo_stream.append "chore-#{@chore.id}-comments-list" do %>
      <%= render "shared/comment", comment: @comment %>
    <% end %>

    <!-- Remove "no comments" message if this is the first comment -->
    <%= turbo_stream.remove "chore-#{@chore.id}-no-comments" %>

    <!-- Always reset the main comment form -->
    <%= turbo_stream.replace "new_comment_chore_#{@chore.id}" do %>
      <%= render "shared/comment_form", commentable: @chore, comment: Comment.new %>
    <% end %>
  <% end %>
<% elsif @meal %>
  <% if @comment.reply? %>
    <!-- For replies, we need to reload the root comment to show the new nested reply -->
    <% root_comment = @comment.root_comment %>
    <%= turbo_stream.replace dom_id(root_comment) do %>
      <%= render "shared/comment", comment: root_comment %>
    <% end %>

    <!-- Hide the reply form after successful submission -->
    <%= turbo_stream.update "reply-form-#{@comment.parent.id}", "" %>
  <% else %>
    <!-- For top-level comments, append to the list -->
    <%= turbo_stream.append "meal-#{@meal.id}-comments-list" do %>
      <%= render "shared/comment", comment: @comment %>
    <% end %>

    <!-- Remove "no comments" message if this is the first comment -->
    <%= turbo_stream.remove "meal-#{@meal.id}-no-comments" %>

    <!-- Always reset the main comment form -->
    <%= turbo_stream.replace "new_comment_meal_#{@meal.id}" do %>
      <%= render "shared/comment_form", commentable: @meal, comment: Comment.new %>
    <% end %>
  <% end %>
<% else %>  
  <!-- For other commentables, redirect to the page -->
  <%= turbo_stream.action :redirect, polymorphic_path(@commentable) %>
<% end %>