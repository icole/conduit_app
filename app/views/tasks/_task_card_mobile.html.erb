<!-- Mobile-first task card design -->
<% is_deleted = defined?(show_restore) && show_restore %>
<% can_swipe_to_backlog = defined?(show_move_to_backlog) && show_move_to_backlog && task.status == 'active' && !is_deleted %>
<% can_swipe_to_activate = defined?(show_prioritize) && show_prioritize && task.status == 'backlog' && !is_deleted %>
<div id="<%= dom_id task %>"
     class="card <%= is_deleted ? 'bg-base-200' : 'bg-base-100' %> border border-base-200 hover:border-base-300 transition-colors mb-3"
     data-task-id="<%= task.id %>"
     <% if can_swipe_to_backlog %>
       data-controller="swipe" data-swipe-url-value="<%= move_to_backlog_task_path(task) %>" data-swipe-method-value="patch" data-swipe-direction-value="left"
     <% elsif can_swipe_to_activate %>
       data-controller="swipe" data-swipe-url-value="<%= prioritize_task_path(task) %>" data-swipe-method-value="patch" data-swipe-direction-value="right"
     <% end %>>

  <div class="card-body p-3 sm:p-4">
    <div class="flex items-start gap-3">
      <!-- Left side: Checkbox -->
      <div class="flex items-center pt-0.5">
        <% if is_deleted %>
          <div class="text-error opacity-50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </div>
        <% else %>
          <%= form_with(model: task, method: :patch, class: "flex") do |form| %>
            <%= form.hidden_field :status, value: task.status == 'completed' ? (task.priority_order ? 'active' : 'backlog') : 'completed' %>
            <button type="submit"
                    class="hover:scale-110 transition-transform"
                    title="<%= task.status == 'completed' ? 'Mark Incomplete' : 'Complete' %>">
              <% if task.status == 'completed' %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-success" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
              <% else %>
                <div class="w-6 h-6 border-2 border-base-300 rounded-full hover:border-primary transition-colors"></div>
              <% end %>
            </button>
          <% end %>
        <% end %>
      </div>

      <!-- Center: Task content -->
      <div class="flex-1 min-w-0 <%= is_deleted ? 'opacity-60' : '' %>">
        <h3 class="font-medium text-sm sm:text-base leading-6 <%= task.status == 'completed' ? 'line-through text-base-content/60' : '' %>">
          <%= task.title %>
        </h3>

        <% if task.description.present? %>
          <p class="text-xs sm:text-sm text-base-content/70 mt-1 <%= task.status == 'completed' ? 'line-through' : '' %>">
            <%= truncate(task.description, length: 100) %>
          </p>
        <% end %>

        <!-- Metadata badges -->
        <div class="flex flex-wrap items-center gap-1.5 mt-2">
          <% if task.assigned_to_user.present? %>
            <span class="badge badge-ghost badge-xs">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <%= task.assigned_to_user.name.split(' ').first %>
            </span>
          <% end %>

          <% if task.due_date %>
            <% badge_class = task.overdue? ? 'badge-error' : (task.due_soon? ? 'badge-warning' : 'badge-ghost') %>
            <span class="badge <%= badge_class %> badge-xs">
              <%= task.due_date.strftime("%b %d") %>
            </span>
          <% end %>

          <% if task.user != current_user %>
            <span class="badge badge-outline badge-xs">
              by <%= task.user.name.split(' ').first %>
            </span>
          <% end %>
        </div>
      </div>

      <!-- Right side: Action menu -->
      <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-ghost btn-xs btn-circle">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
          </svg>
        </div>
        <ul tabindex="0" class="dropdown-content z-50 p-2 shadow-lg bg-base-100 text-base-content rounded-box w-48">
          <% if is_deleted %>
            <li><%= link_to "Restore", restore_task_path(task), data: { turbo_method: :post }, class: "block px-3 py-2 rounded-lg text-success hover:bg-base-200" %></li>
          <% else %>
            <% if can_swipe_to_activate %>
              <li><%= link_to "Activate", prioritize_task_path(task), data: { turbo_method: :patch }, class: "block px-3 py-2 rounded-lg hover:bg-base-200" %></li>
            <% end %>
            <% if can_swipe_to_backlog %>
              <li><%= link_to "To Backlog", move_to_backlog_task_path(task), data: { turbo_method: :patch }, class: "block px-3 py-2 rounded-lg hover:bg-base-200" %></li>
            <% end %>
            <li><%= link_to "Edit", edit_task_path(task), data: { turbo_frame: "_top" }, class: "block px-3 py-2 rounded-lg hover:bg-base-200" %></li>
            <li><%= link_to "Delete", task_path(task), data: { turbo_method: :delete, turbo_confirm: 'Delete this task?' }, class: "block px-3 py-2 rounded-lg text-error hover:bg-base-200" %></li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>
</div>