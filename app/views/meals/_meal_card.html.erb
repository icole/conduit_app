<%
  is_today = meal.scheduled_date == Date.current
  is_tomorrow = meal.scheduled_date == Date.current.tomorrow
  needs_cook = meal.needs_head_cook?
  user_is_cook = meal.user_is_cook?(current_user)
  user_attending = meal.user_attending?(current_user)
  user_maybe = meal.user_maybe?(current_user)
  user_declined = meal.user_declined?(current_user)
  rsvps_open = meal.rsvps_open?

  border_class = if meal.cancelled?
    "border-error/50 opacity-60"
  elsif needs_cook
    "border-warning"
  elsif is_today
    "border-primary"
  else
    "border-base-300"
  end
%>

<%= link_to meal_path(meal), id: "meal_#{meal.id}", class: "card bg-base-100 shadow-lg border-l-4 #{border_class} hover:shadow-xl transition-shadow" do %>
  <div class="card-body p-4">
    <!-- Header: Date, Time, Status -->
    <div class="flex items-center justify-between gap-2">
      <div class="flex items-center gap-3">
        <div class="text-center min-w-12">
          <div class="text-2xl font-bold <%= is_today ? 'text-primary' : '' %>"><%= meal.scheduled_at.day %></div>
          <div class="text-xs text-base-content/60 uppercase"><%= meal.scheduled_at.strftime("%b") %></div>
        </div>
        <div>
          <div class="font-semibold">
            <% if is_today %>
              Today
            <% elsif is_tomorrow %>
              Tomorrow
            <% else %>
              <%= meal.scheduled_at.strftime("%A") %>
            <% end %>
          </div>
          <div class="text-sm text-base-content/70"><%= meal.time_display %></div>
        </div>
      </div>
      <div class="flex flex-col items-end gap-1">
        <% if meal.cancelled? %>
          <div class="badge badge-error badge-sm">Cancelled</div>
        <% elsif !rsvps_open %>
          <div class="badge badge-warning badge-sm">RSVPs Closed</div>
        <% end %>
        <% if user_is_cook %>
          <div class="badge badge-success badge-sm">Cooking</div>
        <% elsif user_attending %>
          <div class="badge badge-info badge-sm">Going</div>
        <% elsif user_maybe %>
          <div class="badge badge-warning badge-sm">Maybe</div>
        <% end %>
      </div>
    </div>

    <!-- Cooks -->
    <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-3 text-sm">
      <% head_cook = meal.meal_cooks.find { |mc| mc.head_cook? } %>
      <% helpers = meal.meal_cooks.reject { |mc| mc.head_cook? } %>
      <% if head_cook %>
        <span><span class="text-base-content/60">Cook:</span> <%= head_cook.user.name.split.first %></span>
      <% elsif needs_cook %>
        <span class="text-warning">Needs cook!</span>
      <% end %>
      <% if helpers.any? %>
        <span><span class="text-base-content/60">Helpers:</span> <%= helpers.map { |mc| mc.user.name.split.first }.join(', ') %></span>
      <% end %>
      <% if meal.cooks.empty? %>
        <span class="text-warning">Needs volunteers!</span>
      <% end %>
    </div>

    <!-- Menu (if present) -->
    <% if meal.menu.present? %>
      <div class="text-sm text-base-content/70 mt-2 line-clamp-1">
        <span class="font-medium">Menu:</span> <%= meal.menu %>
      </div>
    <% end %>

    <!-- Footer: Attendees count and actions -->
    <div class="flex items-center justify-between mt-3 pt-3 border-t border-base-200">
      <div class="text-sm text-base-content/60">
        <span class="font-medium text-base-content"><%= meal.total_attendees %></span> attending
      </div>
      <% if !meal.cancelled? && rsvps_open && !user_is_cook && !user_attending && !user_maybe %>
        <span class="text-primary text-sm font-medium">RSVP â†’</span>
      <% end %>
    </div>
  </div>
<% end %>
