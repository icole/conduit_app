<%
  is_today = meal.scheduled_date == Date.current
  is_tomorrow = meal.scheduled_date == Date.current.tomorrow
  needs_cook = meal.needs_head_cook?
  user_is_cook = meal.user_is_cook?(current_user)
  user_attending = meal.user_attending?(current_user)
  user_maybe = meal.user_maybe?(current_user)
  user_declined = meal.user_declined?(current_user)
  rsvps_open = meal.rsvps_open?
  native_app = hotwire_native_app? rescue false

  border_class = if meal.cancelled?
    "border-error/50 opacity-60"
  elsif needs_cook
    "border-warning"
  elsif is_today
    "border-primary"
  else
    "border-base-300"
  end
%>

<% if native_app %>
  <%= link_to meal_path(meal), id: "meal_#{meal.id}", class: "block px-3 py-2.5 hover:bg-base-200/50" do %>
    <div class="flex items-center gap-3">
      <div class="text-center min-w-10 <%= needs_cook ? 'text-warning' : (is_today ? 'text-primary' : '') %>">
        <div class="text-lg font-bold"><%= meal.scheduled_at.day %></div>
        <div class="text-xs text-base-content/60 uppercase"><%= meal.scheduled_at.strftime("%b") %></div>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2">
          <span class="font-medium text-sm">
            <% if is_today %>Today<% elsif is_tomorrow %>Tomorrow<% else %><%= meal.scheduled_at.strftime("%A") %><% end %>
          </span>
          <span class="text-xs text-base-content/60"><%= meal.time_display %></span>
        </div>
        <div class="text-xs text-base-content/60 mt-0.5 truncate">
          <% head_cook = meal.meal_cooks.find { |mc| mc.head_cook? } %>
          <% if head_cook %>
            Cook: <%= head_cook.user.name.split.first %>
          <% elsif needs_cook %>
            <span class="text-warning">Needs cook!</span>
          <% end %>
          <% if meal.menu.present? %>
            · <%= truncate(meal.menu.to_plain_text, length: 30) %>
          <% end %>
        </div>
      </div>
      <div class="flex flex-col items-end gap-0.5">
        <% if meal.cancelled? %>
          <span class="badge badge-error badge-xs">Cancelled</span>
        <% elsif user_is_cook %>
          <span class="badge badge-success badge-xs">Cooking</span>
        <% elsif user_attending %>
          <span class="badge badge-info badge-xs">Going</span>
        <% elsif user_maybe %>
          <span class="badge badge-warning badge-xs">Maybe</span>
        <% end %>
        <span class="text-xs text-base-content/50">
          <%= meal.total_attendees %><% if meal.guests_count > 0 %><span class="text-base-content/40"> (+<%= meal.guests_count %>)</span><% end %>
        </span>
        <% if meal.late_plate_count > 0 %>
          <span class="text-xs text-secondary/70"><%= meal.late_plate_count %> late</span>
        <% end %>
      </div>
    </div>
  <% end %>
<% else %>
<%= link_to meal_path(meal), id: "meal_#{meal.id}", class: "card bg-base-100 shadow-lg border-l-4 #{border_class} hover:shadow-xl transition-shadow" do %>
  <div class="card-body p-4">
    <!-- Header: Date, Time, Status -->
    <div class="flex items-center justify-between gap-2">
      <div class="flex items-center gap-3">
        <div class="text-center min-w-12">
          <div class="text-2xl font-bold <%= is_today ? 'text-primary' : '' %>"><%= meal.scheduled_at.day %></div>
          <div class="text-xs text-base-content/60 uppercase"><%= meal.scheduled_at.strftime("%b") %></div>
        </div>
        <div>
          <div class="font-semibold">
            <% if is_today %>
              Today
            <% elsif is_tomorrow %>
              Tomorrow
            <% else %>
              <%= meal.scheduled_at.strftime("%A") %>
            <% end %>
          </div>
          <div class="text-sm text-base-content/70"><%= meal.time_display %></div>
        </div>
      </div>
      <div class="flex flex-col items-end gap-1">
        <% if meal.cancelled? %>
          <div class="badge badge-error badge-sm">Cancelled</div>
        <% elsif !rsvps_open %>
          <div class="badge badge-warning badge-sm">RSVPs Closed</div>
        <% end %>
        <% if user_is_cook %>
          <div class="badge badge-success badge-sm">Cooking</div>
        <% elsif user_attending %>
          <div class="badge badge-info badge-sm">Going</div>
        <% elsif user_maybe %>
          <div class="badge badge-warning badge-sm">Maybe</div>
        <% end %>
      </div>
    </div>

    <!-- Cooks -->
    <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-3 text-sm">
      <% head_cook = meal.meal_cooks.find { |mc| mc.head_cook? } %>
      <% helpers = meal.meal_cooks.reject { |mc| mc.head_cook? } %>
      <% if head_cook %>
        <span><span class="text-base-content/60">Cook:</span> <%= head_cook.user.name.split.first %></span>
      <% elsif needs_cook %>
        <span class="text-warning">Needs cook!</span>
      <% end %>
      <% if helpers.any? %>
        <span><span class="text-base-content/60">Helpers:</span> <%= helpers.map { |mc| mc.user.name.split.first }.join(', ') %></span>
      <% end %>
      <% if meal.cooks.empty? %>
        <span class="text-warning">Needs volunteers!</span>
      <% end %>
    </div>

    <!-- Menu (if present) -->
    <% if meal.menu.present? %>
      <div class="text-sm text-base-content/70 mt-2 line-clamp-2">
        <span class="font-medium">Menu:</span> <%= meal.menu.to_plain_text %>
      </div>
    <% end %>

    <!-- Footer: Attendees count and actions -->
    <div class="flex items-center justify-between mt-3 pt-3 border-t border-base-200">
      <div class="text-sm text-base-content/60">
        <span class="font-medium text-base-content"><%= meal.total_attendees %></span> attending<% if meal.guests_count > 0 %><span class="text-base-content/50"> (+<%= meal.guests_count %> guests)</span><% end %><% if meal.late_plate_count > 0 %><span class="text-secondary ml-2"><%= meal.late_plate_count %> late</span><% end %>
      </div>
      <% if !meal.cancelled? && rsvps_open && !user_is_cook && !user_attending && !user_maybe %>
        <span class="text-primary text-sm font-medium">RSVP →</span>
      <% end %>
    </div>
  </div>
<% end %>
<% end %>
