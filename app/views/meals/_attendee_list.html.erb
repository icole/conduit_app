<div class="card bg-base-100 shadow-xl">
  <div class="card-body">
    <h3 class="card-title text-lg flex-wrap gap-2">
      Who's Coming
      <span class="badge badge-primary"><%= meal.total_attendees %> attending</span>
      <% if meal.late_plate_count > 0 %>
        <span class="badge badge-secondary"><%= meal.late_plate_count %> late plate<%= meal.late_plate_count > 1 ? 's' : '' %></span>
      <% end %>
    </h3>
    <% if meal.late_plate_count > 0 %>
      <p class="text-sm text-base-content/60"><%= meal.total_plates %> plates total</p>
    <% end %>

    <%# Dietary Needs Section - only visible to cooks %>
    <% if meal.user_is_cook?(current_user) %>
      <% users_with_dietary_needs = (attending_rsvps + maybe_rsvps + late_plate_rsvps).map(&:user).select { |u| u.dietary_needs.present? } %>
      <% if users_with_dietary_needs.any? %>
        <div class="mt-4 p-4 bg-warning/10 rounded-lg">
          <h4 class="text-sm font-medium text-warning mb-3 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            Dietary Needs
          </h4>
          <div class="space-y-3">
            <% users_with_dietary_needs.each do |user| %>
              <div class="text-sm">
                <div class="font-medium"><%= user.name %></div>
                <div class="text-base-content/80 whitespace-pre-line"><%= user.dietary_needs %></div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>

    <!-- Cooks Section -->
    <% if meal.cooks.any? %>
      <div class="mt-4">
        <h4 class="text-sm font-medium text-base-content/70 mb-2">Cooking</h4>
        <div class="space-y-2">
          <% meal.meal_cooks.includes(:user).each do |mc| %>
            <div class="flex items-center gap-2">
              <div class="avatar placeholder">
                <div class="bg-primary text-primary-content rounded-full w-8">
                  <span class="text-xs"><%= mc.user.name.first(2).upcase %></span>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-sm font-medium truncate"><%= mc.user.name %></div>
                <% if mc.guests_count > 0 %>
                  <div class="text-xs text-base-content/50"><%= mc.guests_display %></div>
                <% end %>
              </div>
              <% if mc.head_cook? %>
                <svg class="w-4 h-4 text-warning" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
              <% end %>
              <% if current_user.admin? %>
                <%= button_to admin_remove_cook_meal_path(meal, user_id: mc.user.id), method: :delete,
                    class: "btn btn-ghost btn-xs btn-square text-error opacity-50 hover:opacity-100",
                    form: { data: { turbo_confirm: "Remove #{mc.user.name} from cooking?" } },
                    title: "Remove cook" do %>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Attending Section -->
    <% if attending_rsvps.any? %>
      <div class="mt-4">
        <h4 class="text-sm font-medium text-base-content/70 mb-2">
          Attending (<%= attending_rsvps.count %>)
        </h4>
        <div class="space-y-2">
          <% attending_rsvps.each do |rsvp| %>
            <div class="flex items-center gap-2">
              <div class="avatar placeholder">
                <div class="bg-success/20 text-success rounded-full w-8">
                  <span class="text-xs"><%= rsvp.user.name.first(2).upcase %></span>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-sm font-medium truncate"><%= rsvp.user.name %></div>
                <% if rsvp.guests_count > 0 %>
                  <div class="text-xs text-base-content/50"><%= rsvp.guests_display %></div>
                <% end %>
                <% if rsvp.notes.present? %>
                  <div class="text-xs text-warning/80 truncate"><%= rsvp.notes %></div>
                <% end %>
              </div>
              <% if current_user.admin? %>
                <%= button_to admin_remove_rsvp_meal_path(meal, user_id: rsvp.user.id), method: :delete,
                    class: "btn btn-ghost btn-xs btn-square text-error opacity-50 hover:opacity-100",
                    form: { data: { turbo_confirm: "Remove RSVP for #{rsvp.user.name}?" } },
                    title: "Remove RSVP" do %>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Maybe Section -->
    <% if maybe_rsvps.any? %>
      <div class="mt-4">
        <h4 class="text-sm font-medium text-base-content/70 mb-2">
          Maybe (<%= maybe_rsvps.count %>)
        </h4>
        <div class="space-y-2">
          <% maybe_rsvps.each do |rsvp| %>
            <div class="flex items-center gap-2 opacity-70">
              <div class="avatar placeholder">
                <div class="bg-warning/20 text-warning rounded-full w-8">
                  <span class="text-xs"><%= rsvp.user.name.first(2).upcase %></span>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-sm truncate"><%= rsvp.user.name %></div>
              </div>
              <% if current_user.admin? %>
                <%= button_to admin_remove_rsvp_meal_path(meal, user_id: rsvp.user.id), method: :delete,
                    class: "btn btn-ghost btn-xs btn-square text-error opacity-50 hover:opacity-100",
                    form: { data: { turbo_confirm: "Remove RSVP for #{rsvp.user.name}?" } },
                    title: "Remove RSVP" do %>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Late Plates Section -->
    <% if late_plate_rsvps.any? %>
      <div class="mt-4">
        <h4 class="text-sm font-medium text-base-content/70 mb-2">
          Late Plates (<%= late_plate_rsvps.count %>)
        </h4>
        <div class="space-y-2">
          <% late_plate_rsvps.each do |rsvp| %>
            <div class="flex items-center gap-2">
              <div class="avatar placeholder">
                <div class="bg-secondary/20 text-secondary rounded-full w-8">
                  <span class="text-xs"><%= rsvp.user.name.first(2).upcase %></span>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-sm truncate"><%= rsvp.user.name %></div>
                <% if rsvp.guests_count > 0 %>
                  <div class="text-xs text-base-content/50"><%= rsvp.guests_display %></div>
                <% end %>
                <% if rsvp.notes.present? %>
                  <div class="text-xs text-warning/80 truncate"><%= rsvp.notes %></div>
                <% end %>
              </div>
              <% if current_user.admin? %>
                <%= button_to admin_remove_rsvp_meal_path(meal, user_id: rsvp.user.id), method: :delete,
                    class: "btn btn-ghost btn-xs btn-square text-error opacity-50 hover:opacity-100",
                    form: { data: { turbo_confirm: "Remove RSVP for #{rsvp.user.name}?" } },
                    title: "Remove RSVP" do %>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Not Attending Section -->
    <% if declined_rsvps.any? %>
      <div class="mt-4">
        <h4 class="text-sm font-medium text-base-content/70 mb-2">
          Can't Make It (<%= declined_rsvps.count %>)
        </h4>
        <div class="space-y-2">
          <% declined_rsvps.each do |rsvp| %>
            <div class="flex items-center gap-2 opacity-50">
              <div class="avatar placeholder">
                <div class="bg-base-300 text-base-content/50 rounded-full w-8">
                  <span class="text-xs"><%= rsvp.user.name.first(2).upcase %></span>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-sm truncate"><%= rsvp.user.name %></div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Empty State -->
    <% if meal.cooks.empty? && attending_rsvps.empty? && maybe_rsvps.empty? && late_plate_rsvps.empty? %>
      <div class="text-center py-4 text-base-content/50">
        <p>No RSVPs yet</p>
      </div>
    <% end %>
  </div>
</div>
