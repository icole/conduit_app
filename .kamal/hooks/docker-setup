#!/bin/bash
echo "Setting up Docker and PostgreSQL on $KAMAL_HOSTS..."

# Install Docker if not present
if ! command -v docker &> /dev/null; then
    sudo apt update
    sudo apt install -y docker.io docker-compose
    sudo systemctl start docker
    sudo systemctl enable docker
fi

# Fix Docker permissions
sudo groupadd -f docker
sudo usermod -aG docker $USER
sudo chown root:docker /var/run/docker.sock
sudo chmod 660 /var/run/docker.sock

# Install PostgreSQL
if ! command -v psql &> /dev/null; then
    sudo apt install -y postgresql postgresql-contrib
    sudo systemctl start postgresql
    sudo systemctl enable postgresql

    # Create user and databases
    sudo -u postgres psql -c "CREATE USER conduit_app WITH PASSWORD '$CONDUIT_APP_DATABASE_PASSWORD';" || true
    sudo -u postgres psql -c "CREATE DATABASE conduit_app_production OWNER conduit_app;" || true
    sudo -u postgres psql -c "CREATE DATABASE conduit_app_production_cache OWNER conduit_app;" || true
    sudo -u postgres psql -c "CREATE DATABASE conduit_app_production_queue OWNER conduit_app;" || true
    sudo -u postgres psql -c "CREATE DATABASE conduit_app_production_cable OWNER conduit_app;" || true
fi

echo "Setup complete!"
