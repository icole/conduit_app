#!/usr/bin/env bash
set -e

# Staging Deployment Verification Script
# This script runs post-deployment smoke tests to verify the staging environment

STAGING_URL="https://conduit-staging.crowwoods.com"
TIMEOUT=10

echo "üîç Verifying staging deployment..."
echo "üìç Target: $STAGING_URL"
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track failures
FAILED_TESTS=0
TOTAL_TESTS=0

# Test function
test_endpoint() {
  local name=$1
  local endpoint=$2
  local expected_status=${3:-200}
  local expected_content=${4:-""}

  TOTAL_TESTS=$((TOTAL_TESTS + 1))

  echo -n "Testing $name... "

  response=$(curl -s -o /dev/null -w "%{http_code}" --max-time $TIMEOUT "$STAGING_URL$endpoint" 2>/dev/null || echo "000")

  if [ "$response" = "$expected_status" ]; then
    # If content check specified, verify it
    if [ -n "$expected_content" ]; then
      content=$(curl -s --max-time $TIMEOUT "$STAGING_URL$endpoint" 2>/dev/null)
      if echo "$content" | grep -q "$expected_content"; then
        echo -e "${GREEN}‚úì${NC} (HTTP $response, content verified)"
      else
        echo -e "${RED}‚úó${NC} (HTTP $response, expected content not found)"
        FAILED_TESTS=$((FAILED_TESTS + 1))
      fi
    else
      echo -e "${GREEN}‚úì${NC} (HTTP $response)"
    fi
  else
    echo -e "${RED}‚úó${NC} (Expected HTTP $expected_status, got $response)"
    FAILED_TESTS=$((FAILED_TESTS + 1))
  fi
}

echo "=== Basic Connectivity ==="
test_endpoint "Health check" "/up" 200 "ok"
test_endpoint "Home page" "/" 200

echo ""
echo "=== Authentication Endpoints ==="
test_endpoint "Login page" "/login" 200
test_endpoint "Logout" "/logout" 302  # Redirects

echo ""
echo "=== API Endpoints ==="
test_endpoint "Chat token API" "/chat/token.json" 401  # Should require auth

echo ""
echo "=== Static Assets ==="
test_endpoint "Favicon" "/favicon.ico" 200

echo ""
echo "=== Database Connectivity ==="
# The /up endpoint already checks database, but we can be more explicit
echo -n "Database connection via health check... "
if curl -s --max-time $TIMEOUT "$STAGING_URL/up" | grep -q "ok"; then
  echo -e "${GREEN}‚úì${NC}"
else
  echo -e "${RED}‚úó${NC}"
  FAILED_TESTS=$((FAILED_TESTS + 1))
fi
TOTAL_TESTS=$((TOTAL_TESTS + 1))

echo ""
echo "=== Performance Checks ==="
echo -n "Response time... "
start_time=$(date +%s%3N)
curl -s --max-time $TIMEOUT "$STAGING_URL/up" > /dev/null
end_time=$(date +%s%3N)
response_time=$((end_time - start_time))

if [ $response_time -lt 3000 ]; then
  echo -e "${GREEN}‚úì${NC} (${response_time}ms - fast)"
elif [ $response_time -lt 5000 ]; then
  echo -e "${YELLOW}‚ö†${NC} (${response_time}ms - acceptable)"
else
  echo -e "${RED}‚úó${NC} (${response_time}ms - slow)"
  FAILED_TESTS=$((FAILED_TESTS + 1))
fi
TOTAL_TESTS=$((TOTAL_TESTS + 1))

echo ""
echo "=== SSL/Security ==="
echo -n "HTTPS redirect... "
http_response=$(curl -s -o /dev/null -w "%{http_code}" --max-time $TIMEOUT "http://conduit-staging.crowwoods.com/" 2>/dev/null || echo "000")
if [ "$http_response" = "301" ] || [ "$http_response" = "302" ] || [ "$http_response" = "308" ]; then
  echo -e "${GREEN}‚úì${NC} (HTTP $http_response - redirects to HTTPS)"
elif [ "$http_response" = "000" ]; then
  echo -e "${YELLOW}‚ö†${NC} (Could not connect via HTTP - may be HTTPS-only)"
else
  echo -e "${YELLOW}‚ö†${NC} (HTTP $http_response - verify HTTPS enforcement)"
fi
TOTAL_TESTS=$((TOTAL_TESTS + 1))

echo -n "SSL certificate... "
if echo | openssl s_client -servername conduit-staging.crowwoods.com -connect conduit-staging.crowwoods.com:443 2>/dev/null | openssl x509 -noout -dates > /dev/null 2>&1; then
  echo -e "${GREEN}‚úì${NC} (Valid)"
else
  echo -e "${YELLOW}‚ö†${NC} (Could not verify - check certificate)"
fi
TOTAL_TESTS=$((TOTAL_TESTS + 1))

echo ""
echo "=================================================="
echo "Summary: $((TOTAL_TESTS - FAILED_TESTS))/$TOTAL_TESTS tests passed"

if [ $FAILED_TESTS -eq 0 ]; then
  echo -e "${GREEN}‚úÖ All tests passed!${NC}"
  echo ""
  echo "Staging environment is healthy and ready for testing."
  exit 0
else
  echo -e "${RED}‚ùå $FAILED_TESTS test(s) failed${NC}"
  echo ""
  echo "Please investigate the failures before proceeding."
  exit 1
fi
