#!/bin/bash
set -e

# Build script for iOS and Android apps
# Usage: bin/build-apps [ios|android|all]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

build_ios() {
    log_info "Building iOS app..."

    cd "$PROJECT_ROOT/ios/Conduit"

    # Clean build folder
    log_info "Cleaning previous build..."
    xcodebuild clean -project Conduit.xcodeproj -scheme Conduit -configuration Release -quiet || true

    # Build archive
    log_info "Creating archive..."
    xcodebuild archive \
        -project Conduit.xcodeproj \
        -scheme Conduit \
        -configuration Release \
        -archivePath "$PROJECT_ROOT/build/ios/Conduit.xcarchive" \
        -destination "generic/platform=iOS" \
        CODE_SIGN_IDENTITY="" \
        CODE_SIGNING_REQUIRED=NO \
        CODE_SIGNING_ALLOWED=NO \
        -quiet

    # Export IPA (if you have export options plist)
    if [ -f "$PROJECT_ROOT/ios/ExportOptions.plist" ]; then
        log_info "Exporting IPA..."
        xcodebuild -exportArchive \
            -archivePath "$PROJECT_ROOT/build/ios/Conduit.xcarchive" \
            -exportPath "$PROJECT_ROOT/build/ios" \
            -exportOptionsPlist "$PROJECT_ROOT/ios/ExportOptions.plist" \
            -quiet
        log_info "iOS IPA created at: build/ios/Conduit.ipa"
    else
        log_info "iOS archive created at: build/ios/Conduit.xcarchive"
        log_warn "To create IPA, add ios/ExportOptions.plist with your export settings"
    fi

    cd "$PROJECT_ROOT"
}

build_android() {
    log_info "Building Android app..."

    cd "$PROJECT_ROOT/android"

    # Clean
    log_info "Cleaning previous build..."
    ./gradlew clean -q

    # Build release APK
    log_info "Building release APK..."
    ./gradlew assembleRelease -q

    # Build release bundle (AAB) for Play Store
    log_info "Building release bundle (AAB)..."
    ./gradlew bundleRelease -q

    # Copy outputs to build directory
    mkdir -p "$PROJECT_ROOT/build/android"

    if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
        cp app/build/outputs/apk/release/app-release.apk "$PROJECT_ROOT/build/android/conduit-release.apk"
        log_info "Android APK created at: build/android/conduit-release.apk"
    fi

    if [ -f "app/build/outputs/bundle/release/app-release.aab" ]; then
        cp app/build/outputs/bundle/release/app-release.aab "$PROJECT_ROOT/build/android/conduit-release.aab"
        log_info "Android AAB created at: build/android/conduit-release.aab"
    fi

    cd "$PROJECT_ROOT"
}

show_usage() {
    echo "Usage: bin/build-apps [ios|android|all]"
    echo ""
    echo "Options:"
    echo "  ios      Build iOS app only"
    echo "  android  Build Android app only"
    echo "  all      Build both iOS and Android apps (default)"
    echo ""
    echo "Outputs are placed in the build/ directory"
}

# Main
TARGET="${1:-all}"

case "$TARGET" in
    ios)
        build_ios
        ;;
    android)
        build_android
        ;;
    all)
        build_ios
        build_android
        ;;
    -h|--help|help)
        show_usage
        exit 0
        ;;
    *)
        log_error "Unknown target: $TARGET"
        show_usage
        exit 1
        ;;
esac

log_info "Build complete!"
