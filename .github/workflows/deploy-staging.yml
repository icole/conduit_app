name: Deploy to Staging

on:
  push:
    branches: [ staging ]
  workflow_dispatch:  # Allow manual triggering

# Cancel in-progress deploys to the same branch
concurrency:
  group: deploy-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Run all CI checks first (same as main branch)
  ci-checks:
    name: Run CI Checks
    uses: ./.github/workflows/ci.yml

  # Deploy to staging if CI passes
  deploy:
    name: Deploy to Staging
    needs: ci-checks
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://conduit-staging.crowwoods.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Create Kamal secrets file
        run: |
          mkdir -p .kamal
          cat > .kamal/secrets.staging << EOF
          # Kamal Staging Secrets (Auto-generated by GitHub Actions)
          # DO NOT commit this file - it contains sensitive credentials

          # Rails configuration
          export RAILS_MASTER_KEY="${{ secrets.RAILS_MASTER_KEY }}"
          export SECRET_KEY_BASE="${{ secrets.SECRET_KEY_BASE }}"

          # Database
          export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"

          # External services
          export GOOGLE_OAUTH_CLIENT_ID="${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}"
          export GOOGLE_OAUTH_CLIENT_SECRET="${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}"
          export GOOGLE_CALENDAR_ID="${{ secrets.GOOGLE_CALENDAR_ID }}"
          export STREAM_API_KEY="${{ secrets.STREAM_API_KEY }}"
          export STREAM_API_SECRET="${{ secrets.STREAM_API_SECRET }}"

          # Email (Staging uses SMTP)
          export SMTP_ADDRESS="${{ secrets.SMTP_ADDRESS }}"
          export SMTP_PORT="${{ secrets.SMTP_PORT }}"
          export SMTP_USERNAME="${{ secrets.SMTP_USERNAME }}"
          export SMTP_PASSWORD="${{ secrets.SMTP_PASSWORD }}"
          export SMTP_DOMAIN="${{ secrets.SMTP_DOMAIN }}"

          # Docker Registry
          export KAMAL_REGISTRY_PASSWORD="${{ secrets.DOCKER_PASSWORD }}"
          EOF

          # Verify file was created
          if [ ! -f .kamal/secrets.staging ]; then
            echo "‚ùå Failed to create secrets file"
            exit 1
          fi

          echo "‚úÖ Secrets file created successfully"

      - name: Deploy with Kamal
        env:
          RAILS_ENV: production
          KAMAL_REGISTRY_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "üöÄ Starting deployment to staging..."

          # Run Kamal deployment
          bundle exec kamal deploy -c config/deploy.staging.yml

          echo "‚úÖ Deployment completed"

      - name: Run post-deployment health check
        run: |
          echo "üè• Running health check..."

          # Wait for app to be ready (max 60 seconds)
          max_attempts=12
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -f --max-time 5 https://conduit-staging.crowwoods.com/up; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi

            attempt=$((attempt + 1))
            echo "‚è≥ Attempt $attempt/$max_attempts failed, retrying in 5 seconds..."
            sleep 5
          done

          echo "‚ùå Health check failed after $max_attempts attempts"
          exit 1

      - name: Run smoke tests
        run: |
          echo "üß™ Running smoke tests..."

          # Test home page
          if curl -f --max-time 10 https://conduit-staging.crowwoods.com/ > /dev/null 2>&1; then
            echo "‚úÖ Home page accessible"
          else
            echo "‚ùå Home page failed"
            exit 1
          fi

          # Test API endpoint (health check)
          if curl -f --max-time 5 https://conduit-staging.crowwoods.com/up | grep -q "ok"; then
            echo "‚úÖ API responding correctly"
          else
            echo "‚ùå API health check failed"
            exit 1
          fi

          echo "‚úÖ All smoke tests passed!"

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚úÖ Staging Deployment Successful

              **Environment:** https://conduit-staging.crowwoods.com
              **Commit:** ${context.sha.substring(0, 7)}
              **Deployed by:** @${context.actor}

              ### Next Steps
              - [ ] Test backend changes
              - [ ] Test mobile apps (if applicable)
              - [ ] Verify database migrations
              - [ ] Sign off before merging to main
              `
            })

      - name: Notify on success
        if: success()
        run: |
          echo "::notice::üéâ Staging deployment successful! https://conduit-staging.crowwoods.com"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::‚ùå Staging deployment failed. Check logs for details."

  # Optional: Post-deployment verification
  verify:
    name: Verify Deployment
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Run deployment verification script
        run: |
          # This is a placeholder for a more comprehensive verification script
          # You could create bin/verify-staging that runs actual integration tests

          echo "üîç Verifying deployment..."

          # Example: Check database migrations status
          # bundle exec kamal app exec -c config/deploy.staging.yml 'bin/rails db:migrate:status'

          echo "‚úÖ Verification complete"
